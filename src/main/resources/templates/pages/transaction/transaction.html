<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Danh sách giao dịch</title>
    <link rel="stylesheet" th:href="@{admin/vendors/mdi/css/materialdesignicons.min.css}">
    <link rel="stylesheet" th:href="@{admin/vendors/css/vendor.bundle.base.css}">
    <link rel="stylesheet" th:href="@{admin/css/style.css}" />
    <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.svg" />
</head>

<style>
    .dropdown-menu {
        min-width: 300px;
    }
</style>

<body>
    <div class="container-scroller d-flex">
        <div class="offcanvas offcanvas-start" id="sidebarOffcanvas" th:insert="../templates/pages/sidebar.html"></div>
        <div class="container-fluid">
            <div th:insert="../templates/pages/navbar.html"></div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-3">
            <div class="col">
                <h2 class="text-center" style="font-weight: bolder;">Danh sách giao dịch</h2>
            </div>
        </div>

        <form id="filterForm" th:action="@{/transaction}" method="get">
            <input type="hidden" name="pageNo" id="pageNo" value="0" />
            <div class="row mb-3">

                <div class="col-md-2">
                    <input type="text" class="form-control" name="searchTerm" id="searchTerm" th:value="${searchTerm}"
                        placeholder="Nhập từ khóa tìm kiếm">
                </div>

                <div class="col-md-2">
                    <select class="form-select" name="searchColumn" id="searchColumn">
                        <option value="" selected>Chọn cột tìm kiếm</option>
                        <option value="orderId" th:selected="${searchColumn == 'orderId'}">Mã đơn hàng</option>
                        <option value="bankName" th:selected="${searchColumn == 'bankName'}">Tên Ngân hàng</option>
                        <option value="accountNumber" th:selected="${searchColumn == 'accountNumber'}">Tài khoản thanh
                            toán</option>
                        <option value="accountName" th:selected="${searchColumn == 'accountName'}">Chủ tài khoản
                        </option>
                        <option value="username" th:selected="${searchColumn == 'username'}">Username</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <select class="form-select" aria-label="Trạng thái đơn hàng" id="statusFilter" name="status">
                        <option value="" selected>Trạng thái đơn hàng</option>
                        <option value="Completed" th:selected="${status == 'Completed'}">Hoàn thành</option>
                        <option value="Error" th:selected="${status == 'Error'}">Lỗi</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button class="btn btn-dark dropdown-toggle" type="button" id="dateFilterDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        Thời gian
                    </button>
                    <div class="dropdown-menu p-3" aria-labelledby="dateFilterDropdown">
                        <div class="mb-3">
                            <label for="dateFrom" class="form-label">Từ</label>
                            <input type="date" class="form-control" id="dateFrom" name="dateFrom"
                                th:value="${dateFrom}">
                        </div>
                        <div class="mb-3">
                            <label for="dateTo" class="form-label">Đến</label>
                            <input type="date" class="form-control" id="dateTo" name="dateTo" th:value="${dateTo}">
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="resetDateFilter">Đặt lại</button>
                            <button type="button" class="btn btn-primary" id="applyDateFilter">Áp dụng</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">Áp dụng bộ lọc</button>
                </div>

                <div class="col-md-2">
                    <button type="button" id="resetFilters" class="btn btn-secondary">Đặt lại bộ lọc</button>
                </div>

            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col" class="fw-bold text-center">Mã đơn hàng</th>
                        <th scope="col" class="fw-bold text-center">Ngân hàng</th>
                        <th scope="col" class="fw-bold text-center">Tài khoản thanh toán</th>
                        <th scope="col" class="fw-bold text-center">Chủ tài khoản</th>
                        <th scope="col" class="fw-bold text-center">Username</th>
                        <th scope="col" class="fw-bold text-center">Email</th>
                        <th scope="col" class="fw-bold text-center">Tổng tiền</th>
                        <th scope="col" class="fw-bold text-center">Ngày tạo</th>
                        <th scope="col" class="fw-bold text-center">Trạng thái</th>
                        <th scope="col" class="fw-bold text-center">Chi tiết</th>
                    </tr>
                </thead>
                <tbody>
                    <div th:each="transaction : ${transactions}">
                        <tr>
                            <td class="text-center" th:text="${transaction.order.id}"></td>
                            <td class="text-center"><span class="bank-name"
                                    th:data-bank-id="${transaction.bankId}"></span></td>
                            <td class="text-center" th:text="${transaction.accountNumber}"></td>
                            <td th:text="${transaction.accountName != null ? transaction.accountName : 'UNKNOWN'}"></td>
                            <td class="text-center" th:text="${transaction.user.username}"></td>
                            <td class="text-center" th:text="${transaction.user.email}"></td>
                            <td
                                th:text="${#numbers.formatDecimal(transaction.amount, 1, 'POINT', 0, 'COMMA')} + ' VND'">
                            </td>
                            <td class="text-center"
                                th:text="${#dates.format(transaction.transactionDate, 'dd-MM-yyyy HH:mm:ss')}"></td>
                            <td class="text-center">
                                <span th:class="${'badge ' +
                                    (transaction.order.status == 'Pending' ? 'bg-warning text-dark' :
                                    (transaction.order.status == 'Completed' ? 'bg-success' :
                                    (transaction.order.status == 'Reject' ? 'bg-danger' :
                                    (transaction.order.status == 'Error' ? 'bg-secondary' : 'bg-info'))))}">
                                    <span th:text="${transaction.order.status}"></span>
                                </span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary view-order-details"
                                    th:data-order-id="${transaction.order.id}">
                                    Chi tiết
                                </button>
                            </td>
                        </tr>
                    </div>
                </tbody>
            </table>
        </div>

        <hr>
        <!-- Phần phân trang -->
        <!-- Pagination section -->
        <nav th:if="${totalPages > 0}" aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/transaction(pageNo=${currentPage - 1}, status=${status}, dateFrom=${dateFrom}, dateTo=${dateTo}, searchColumn=${searchColumn}, searchTerm=${searchTerm})}">Previous</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                        th:href="@{/transaction(pageNo=${i}, status=${status}, dateFrom=${dateFrom}, dateTo=${dateTo}, searchColumn=${searchColumn}, searchTerm=${searchTerm})}"
                        th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/transaction(pageNo=${currentPage + 1}, status=${status}, dateFrom=${dateFrom}, dateTo=${dateTo}, searchColumn=${searchColumn}, searchTerm=${searchTerm})}">Next</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Modal order detail -->
    <div aria-hidden="true" aria-labelledby="orderDetailsModalLabel" class="modal fade" id="orderDetailsModal"
        tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Chi tiết Đơn hàng</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nhà phát hành</th>
                                <th>Số seri</th>
                                <th>Mã thẻ</th>
                                <th>Giá tiền</th>
                            </tr>
                        </thead>
                        <tbody id="modalOrderDetails"></tbody>
                    </table>

                    <div id="transactionDetails">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-alt" data-bs-dismiss="modal" type="button">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- base:js -->
    <script src="admin/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page-->
    <script src="admin/vendors/chart.js/Chart.min.js"></script>
    <script src="admin/js/jquery.cookie.js" type="text/javascript"></script>
    <!-- End plugin js for this page-->
    <!-- inject:js -->
    <script src="admin/js/off-canvas.js"></script>
    <script src="admin/js/hoverable-collapse.js"></script>
    <script src="admin/js/template.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <script src="admin/js/jquery.cookie.js" type="text/javascript"></script>
    <!-- End plugin js for this page -->
    <!-- Custom js for this page-->
    <script src="admin/js/dashboard.js"></script>
    <!-- End custom js for this page-->

    <script>
        const bankMap = {
            // napas
            "963388": "BIDV",
            "970499": "Agribank",
            "970489": "Vietinbank",
            "970406": "DongABank",
            "161087": "Saigonbank",
            "970488": "BIDV",
            "970468": "SeABank",
            "970408": "GP.Bank",
            "970430": "PG Bank",
            "970412": "PVcomBank",
            "970452": "Kienlongbank",
            "970454": "Vietcapital Bank",
            "970433": "VietBank",
            "970414": "OceanBank",
            "970403": "Sacombank",
            "970459": "ABBank",
            "970421": "Ngân hàng Liên doanh Việt Nga", // No common short name
            "686868": "VCB",
            "970416": "ACB",
            "452999": "Eximbank",
            "970423": "TPBank",
            "970443": "SHB",
            "970437": "HDBank",
            "970422": "MBBank",
            "981957": "VPBank",
            "180906": "VIB",
            "166888": "Ngân hàng TMCP Việt Á", // No common short name
            "888899": "Techcombank",
            "970448": "OCB",
            "818188": "NCB",
            "970442": "HLBVN",
            "970449": "LienVietPostBank",
            "970409": "BacABank",
            "970438": "BVB",
            "970424": "ShinhanVN",
            "970439": "VID Public",
            "157979": "SCB",
            "970426": "MaritimeBank",
            "970428": "Ngân hàng TMCP Nam Á", // No common short name
            "970434": "Ngân hàng TNHH Indovina", // No common short name
            "970457": "Woori Việt Nam", // No common short name
            "970455": "IBK",
            "970446": "Co-op Bank",
            "422589": "CIMB",
            "970458": "UOB",

            // other
            "970436": "Vietcombank",
            "526418": "Vietcombank",
            "428310": "Vietcombank",
            "621295": "Vietcombank",
            "377160": "Vietcombank",
            "469173": "Vietcombank",
            "477390": "Vietcombank",
            "403277": "Vietcombank",
            "222806": "Vietcombank",
            "452404": "Vietcombank",
            "970416": "ACB",
            "422151": "Sacombank",
            "436438": "Sacombank",
            "436445": "Sacombank",
            "467964": "Sacombank",
            "469654": "Sacombank",
            "472074": "Sacombank",
            "472075": "Sacombank",
            "486265": "Sacombank",
            "512341": "Sacombank",
            "526830": "Sacombank",
            "620009": "Sacombank",
            "621055": "Sacombank",
            "625002": "Sacombank",
            "970403": "Sacombank",
            "401520": "Sacombank",
            "461337": "Sacombank",
            "461138": "Sacombank",
            "461140": "Sacombank",
            "466243": "Sacombank",
            "356480": "Sacombank",
            "356481": "Sacombank",
            "552332": "Sacombank",
            "517416": "Sacombank",
            "534437": "Sacombank",
            "356062": "Sacombank",
            "357115": "Sacombank",
            "412725": "Sacombank",
            "423325": "Sacombank",
            "455376": "Sacombank",
            "970431": "Eximbank",
            "970423": "TPBank",
            "970443": "SHB",
            "970437": "HDBank",
            "498766": "HDBank",
            "498767": "HDBank",
            "498768": "HDBank",
            "498769": "HDBank",
            "462478": "HDBank",
            "416259": "HDBank",
            "515131": "HDBank",
            "532137": "HDBank",
            "970422": "MBBank",
            "548566": "MBBank",
            "484803": "MBBank",
            "484804": "MBBank",
            "472674": "MBBank",
            "356418": "MBBank",
            "356419": "MBBank",
            "356433": "MBBank",
            "97042292": "MBBank", // viettelpay
            "97042293": "MBBank", // viettelpay
            "970408": "GPBank",
            "559463": "GPBank",
            "970432": "VPBank",
            "520395": "VPBank",
            "520399": "VPBank",
            "521377": "VPBank",
            "524394": "VPBank",
            "528626": "VPBank",
            "454119": "VPBank",
            "523975": "VPBank",
            "518966": "VPBank",
            "406453": "VPBank",
            "454107": "VPBank",
            "405280": "VPBank",
            "478668": "VPBank",
            "419834": "VPBank",
            "97044168": "VIB",
            "970414": "OceanBank",
            "457560": "OceanBank",
            "457561": "OceanBank",
            "436467": "OceanBank",
            "436468": "OceanBank",
            "970427": "VietABank",
            "402534": "VietABank",
            "970407": "Techcombank",
            "970448": "OCB",
            "970419": "NCB",
            "970442": "Hongleong",
            "970449": "LienVietPostBank",
            "970415": "Viettinbank",
            "970425": "ABBank",
            "970409": "BacABank",
            "970438": "BaoVietBank",
            "970424": "ShinhanBank",
            "469672": "ShinhanBank",
            "469673": "ShinhanBank",
            "469674": "ShinhanBank",
            "403013": "ShinhanBank",
            "421595": "ShinhanBank",
            "462842": "ShinhanBank",
            "462843": "ShinhanBank",
            "462844": "ShinhanBank",
            "970439": "PublicBank",
            "417354": "PublicBank",
            "475771": "PublicBank",
            "970440": "SeABank",
            "540392": "SeABank",
            "537158": "SeABank",
            "437420": "SeABank",
            "437421": "SeABank",
            "436545": "SeABank",
            "436546": "SeABank",
            "476636": "SeABank",
            "405082": "SeABank",
            "523611": "SeABank",

            "489516": "SCB",
            "489517": "SCB",
            "489518": "SCB",
            "510235": "SCB",
            "545579": "SCB",
            "554627": "SCB",
            "550796": "SCB",
            "453618": "SCB",
            "512454": "SCB",
            "547139": "SCB",
            "970429": "SCB",

            "970426": "MSB",
            "511409": "MSB",
            "521976": "MSB",
            "510995": "MSB",
            "516249": "MSB",
            "402295": "MSB",
            "430389": "MSB",
            "532451": "MSB",
            "472265": "MSB",
            "412189": "MSB",
            "402204": "MSB",
            "479155": "MSB",
            "970418": "BIDV",
            "970406": "DongABank",
            "970452": "KienLongBank",
            "970430": "PGBank",
            "970400": "SaigonBank",

            "970405": "Agribank",
            "970412": "PVcomBank",
            "538742": "PVcomBank",
            "542553": "PVcomBank",
            "511962": "PVcomBank",
            "519501": "PVcomBank",
            "517454": "PVcomBank"
        };

        // 2. bankname update function
        function updateBankNames() {
            const bankElements = document.querySelectorAll('.bank-name');
            bankElements.forEach(element => {
                const bankId = element.getAttribute('data-bank-id');
                const bankName = bankMap[bankId] || 'Unknown Bank';
                element.textContent = bankName;
                element.setAttribute('data-bank-name', bankName); // Store the bank name
            });
        }
        function filterTableByBankName(bankName) {
            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const bankNameCell = row.querySelector('.bank-name');
                if (bankNameCell) {
                    const cellBankName = bankNameCell.textContent.toLowerCase();
                    if (cellBankName.includes(bankName.toLowerCase())) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            updateBankNames();
            // 5. Event Listeners:
            // When the "view-order-details" button is clicked:
            $(document).on('click', '.view-order-details', function () {
                const orderId = $(this).data('order-id');
                fetchOrderDetails(orderId);
            });
            // 1. bankId to bankName mapping


            // 3. Function for Fetching Order Details:
            function fetchOrderDetails(orderId) {
                $.ajax({
                    url: `/transaction/order-details/${orderId}`,
                    type: 'GET',
                    success: (response) => {
                        if (response.success) {
                            displayOrderDetails(response.order, response.orderDetails);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: () => {
                        alert('Error fetching order details.');
                    }
                });
            }

            // 4. Function for Displaying Order Details in Modal:
            function displayOrderDetails(order, orderDetails) {
                let orderDetailsHtml = '';
                for (const detail of orderDetails) {
                    // Check for null values and replace with empty strings
                    const seriNumber = detail.seriNumber || ''; // If null, use empty string
                    const cardNumber = detail.cardNumber || ''; // If null, use empty string

                    orderDetailsHtml += `
            <tr>
                <td>${detail.publisherName}</td>
                <td>${seriNumber}</td> 
                <td>${cardNumber}</td> 
                <td>${detail.unitPrice.toLocaleString()}</td>
            </tr>
        `;
                }

                $('#modalOrderDetails').html(orderDetailsHtml);
                $('#orderDetailsModal').modal('show');
            }


            const searchColumn = document.getElementById('searchColumn');
            const searchTerm = document.getElementById('searchTerm');

            searchColumn.addEventListener('change', () => {
                if (searchColumn.value === 'bankName') {
                    searchTerm.placeholder = 'Nhập tên ngân hàng';
                } else {
                    searchTerm.placeholder = 'Nhập từ khóa tìm kiếm';
                }
            });

            document.getElementById('filterForm').addEventListener('submit', (e) => {
                if (searchColumn.value === 'bankName') {
                    e.preventDefault();
                    filterTableByBankName(searchTerm.value);
                }
            });
        });
        // Add this function to update bank names after table content changes
        function updateTableContent() {
            // This function should be called after the table content is updated
            // For example, after loading new data or applying filters
            updateBankNames();
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dateFilterDropdown = document.getElementById('dateFilterDropdown');
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            const resetDateFilter = document.getElementById('resetDateFilter');
            const applyDateFilter = document.getElementById('applyDateFilter');

            // Update button text based on selected dates
            function updateButtonText() {
                if (dateFrom.value && dateTo.value) {
                    dateFilterDropdown.textContent = `${dateFrom.value} - ${dateTo.value}`;
                } else if (dateFrom.value) {
                    dateFilterDropdown.textContent = `From ${dateFrom.value}`;
                } else if (dateTo.value) {
                    dateFilterDropdown.textContent = `To ${dateTo.value}`;
                } else {
                    dateFilterDropdown.textContent = 'Thời gian';
                }
            }

            // Reset date inputs
            resetDateFilter.addEventListener('click', function () {
                dateFrom.value = '';
                dateTo.value = '';
                updateButtonText();
            });

            // Apply date filter
            applyDateFilter.addEventListener('click', function () {
                updateButtonText();
                // Close the dropdown
                bootstrap.Dropdown.getInstance(dateFilterDropdown).hide();
            });

            // Update text when dates change
            dateFrom.addEventListener('change', updateButtonText);
            dateTo.addEventListener('change', updateButtonText);

            // Initial text update
            updateButtonText();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchColumn = document.getElementById('searchColumn');
            const searchTerm = document.getElementById('searchTerm');
            const filterForm = document.getElementById('filterForm');

            searchColumn.addEventListener('change', function () {
                if (this.value === 'bankName') {
                    searchTerm.placeholder = 'Nhập tên ngân hàng';
                } else {
                    searchTerm.placeholder = 'Nhập từ khóa tìm kiếm';
                }
            });

            filterForm.addEventListener('submit', function (e) {
                if (searchColumn.value === 'bankName') {
                    e.preventDefault();
                    filterBanksByName(searchTerm.value);
                }
            });

            function filterBanksByName(name) {
                const rows = document.querySelectorAll('table tbody tr');
                const lowercaseName = name.toLowerCase();
                rows.forEach(row => {
                    const bankNameCell = row.querySelector('.bank-name');
                    if (bankNameCell) {
                        const bankName = bankNameCell.textContent.toLowerCase();
                        if (bankName.includes(lowercaseName)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const filterForm = document.getElementById('filterForm');
            const resetButton = document.getElementById('resetFilters');
            const searchColumn = document.getElementById('searchColumn');
            const searchTerm = document.getElementById('searchTerm');
            const statusFilter = document.getElementById('statusFilter');
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');

            resetButton.addEventListener('click', function () {
                // Reset all form inputs
                filterForm.reset();

                // Reset select elements to their first option
                statusFilter.selectedIndex = 0;
                searchColumn.selectedIndex = 0;

                // Clear date inputs
                dateFrom.value = '';
                dateTo.value = '';

                // Clear search term
                searchTerm.value = '';

                // Reset any custom placeholders
                searchTerm.placeholder = 'Nhập từ khóa tìm kiếm';

                // If you have any custom dropdowns or date pickers, reset them here
                // For example, if you're using the date range dropdown we discussed earlier:
                if (typeof updateButtonText === 'function') {
                    updateButtonText();
                }

                // Optionally, you can automatically submit the form to refresh the results
                // filterForm.submit();

                // Or, if you prefer, you can redirect to the base transaction page
                window.location.href = '/transaction';
            });
        });
    </script>
</body>

</html>